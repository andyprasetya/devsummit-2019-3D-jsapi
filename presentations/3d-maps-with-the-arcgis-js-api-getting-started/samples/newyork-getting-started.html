<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Measurement in 3D - 4.10</title>

  <style>
  html, body, #viewDiv {
    padding: 0;
    margin: 0;
    height: 100%;
    width: 100%;
  }

  .esri-legend {
    width: 120px !important;
  }

  /* background-image: url(../images/bg-4.png);
}
.reveal .slide-background-content {
    position: absolute;
    width: 100%;
    height: 100%;
    background-position: 50% 50%;
    background-repeat: no-repeat;
    background-size: cover; */

  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/css/main.css">
  <script src="https://js.arcgis.com/4.11/"></script>

  <script>

    require([
        "esri/layers/SceneLayer",
        "esri/Map",
        "esri/webscene/Slide",
        "esri/views/SceneView",
        "esri/Graphic",
        "esri/layers/FeatureLayer",
        "esri/layers/TileLayer",
        "esri/widgets/LayerList",
        "esri/widgets/Legend",
        "esri/symbols/PointSymbol3D",
        "esri/widgets/AreaMeasurement3D",
        "esri/widgets/Slice",
        "esri/core/Collection",
        "esri/geometry/SpatialReference",
        "esri/core/watchUtils",
        "dojo/domReady!"
      ], function(SceneLayer, Map, Slide, SceneView, Graphic, FeatureLayer, TileLayer, LayerList, Legend, PointSymbol3D, AreaMeasurement3D, Slice, Collection, SpatialReference, watchUtils) {

      var buildingLayer;

      // Load webscene and display it in a SceneView
      const map = new Map({
        basemap: "gray"
      });

      const view = new SceneView({
        container: "viewDiv",
        container: viewDiv,
        map: map,
        qualityProfile: "high",
        environment: {
          lighting: {
          //  directShadowsEnabled: true,
          }
        }
      });

      function onclick(buttonId, onclick) {
        var button = window.parent.document.getElementById(buttonId);
        if (button && onclick) {
          button.onclick = function() {
            view.when(onclick).catch(console.error);
          };
        }
      }

      buildingLayer = new SceneLayer({
        portalItem: {
          id: "2e0761b9a4274b8db52c4bf34356911e"
        }
      });
      map.add(buildingLayer);
      buildingLayer.visible = false;

      var buildingInfoLayer = new FeatureLayer({
        url: "https://services2.arcgis.com/cFEFS0EWrhfDeVw9/ArcGIS/rest/services/Centroids_Manhattan_Information/FeatureServer/0",
        popupEnabled: true,
        outFields: ["*"],
        featureReduction: {
          type: "selection"
        },
        elevationInfo: {
          mode: "relative-to-scene"
        },
        definitionExpression: "NOT WIKI = 0",
        popupTemplate: {
          title: "{NAME}",
          content: [{
            type: "fields",
            fieldInfos: [{
              fieldName: "CNSTRCT_YR",
              label: "Built (year)"
            }, {
              fieldName: "HEIGHT",
              label: "Height (feet)"
            }]
          }]
        }
      });

      view.when(function() {
        // Watch for when features are selected
        view.popup.watch("selectedFeature", function(graphic) {
          if (graphic) {
            console.log("Selected", graphic);
          }
        });
      });

      map.add(buildingInfoLayer);
      buildingInfoLayer.visible = false;

      view.on("click",function(event) {
        if (event.mapPoint) {
          console.log("[" + event.mapPoint.x + ", " + event.mapPoint.y + "]", event);
        }
      });
      window.view = view;

      function onshow(slideTitle, onshow) {
        view.when(function() {
          if (slideTitle === window.parent.Reveal.getCurrentSlide().dataset.title) {
            onshow();
          }
        }).catch(console.error);
      }

      // Change initial camera
      view.camera = {
        position: {
          spatialReference: { latestWkid: 3857, wkid: 102100 },
          x: -8240001.912656185,
          y: 4965766.183306284,
          z: 1158.766359015368
        },
        heading: 25.741026394532483,
        tilt: 70.68845366403269
      };

      // Add a layer list widget
      const layerList = new LayerList({
        view: view
      });

      view.ui.add(layerList, "top-right");


      // Slide: Add Tile Layer

      onshow("add-tile-layer", function() {

      });

      onclick("addTileLayerButton", function() {
        var tileLayer = new TileLayer({
          url: "https://tiles.arcgis.com/tiles/nGt4QxSblgDfeJn9/arcgis/rest/services/New_York_Housing_Density/MapServer",
        });
        map.layers.add(tileLayer);
      });

      // Slide: Add Feature Layer

      onshow("add-feature-layer", function() {
      });

      onclick("addFeatureLayerButton", function() {
        buildingInfoLayer.visible = true;
      });

      // Slide: Add Scene Layer

      var buildingCamera = {
        position: {
          spatialReference: { latestWkid: 3857, wkid: 102100 },
          x: -8240538.828170943,
          y: 4967249.091493763,
          z: 674.923526018858
        },
        heading: 42.14891809020711,
        tilt: 71.860780884195
      };

      onshow("add-scene-layer", function() {
        view.camera = buildingCamera;
      });

      onclick("addSceneLayerButton", function() {
        buildingLayer.visible = true;
      });

      // Slide: Visualize Feature Layer

      onshow("feature-layer-renderer", function() {
        buildingInfoLayer.visible = true;
        buildingInfoLayer.screenSizePerspectiveEnabled = false;
      });

      onclick("changeFeatureLayerRendererButton", function() {
        buildingInfoLayer.visible = true;
        buildingInfoLayer.renderer = {
          type: "simple",
          symbol: new PointSymbol3D({
            symbolLayers: [{
              type: "icon",
              anchor: "bottom",
              size: 18,
              resource: {
                href: "https://static.arcgis.com/arcgis/styleItems/Icons/thumbnails/Pushpin5.png"
              },
              material: {
                color: "red"
              }
            }],
          })
        };
      });

      onclick("improvePerspectiveButton", function() {
        buildingInfoLayer.screenSizePerspectiveEnabled =
          !buildingInfoLayer.screenSizePerspectiveEnabled;
      });


      // Slide: Visualize Scene Layer

      var financialDistrictCamera = {
        position: {
          spatialReference: { latestWkid: 3857, wkid: 102100 },
          x: -8241591.173219887,
          y: 4968398.853917105,
          z: 1206.7576631940901
        },
        heading: 72.21736621211956,
        tilt: 62.04295188404388
      };

      onshow("scene-layer-renderer", function() {
        view.camera = financialDistrictCamera;
        buildingLayer.visible = true;
      });

      onclick("changeBuildingRendererButton", function() {
        buildingLayer.renderer = {
          type: "simple",
          symbol: {
            type: "mesh-3d", // autocasts as new MeshSymbol3D()
            symbolLayers: [{
              type: "fill", // autocasts as new FillSymbol3DLayer()
              material: {
                color: [153, 204, 203]
              }
            }]
          }
        };
      });

      onclick("addEdgesButton", function() {
        buildingLayer.renderer = {
          type: "simple",
          symbol: {
            type: "mesh-3d", // autocasts as new MeshSymbol3D()
            symbolLayers: [{
              type: "fill", // autocasts as new FillSymbol3DLayer()
              material: {
                color: [153, 204, 203]
              },
              edges: {
                type: "solid", // autocasts as new SolidEdges3D()
                color: [50, 50, 50, 0.5]
              }
            }]
          }
        };
      });

      onclick("addShadowsButton", function() {
        view.environment.lighting.directShadowsEnabled = true;
      });

      onclick("improvePerspectiveButton", function() {
        buildingInfoLayer.screenSizePerspectiveEnabled =
          !buildingInfoLayer.screenSizePerspectiveEnabled;
      });

    });

  </script>
</head>

<body>
  <div id="viewDiv"></div>
</body>

</html>
